# 12. 입출력 시스템(I/O System)

컴퓨터의 두 가지 주요 작업은 계산과 입출력 작업이다

많은 경우 입출력 작업이 계산 작업보다 더 많다

예를 들어, 웹 페이지를 읽거나 파일을 편집할 때, 대부분의 일은 정보를 읽거나 기록하는 것이다

입출력 시 운영체제의 역할은 입출력 작업 및 입출력 장치를 관리하고 제어하는 일이다

다른장에서도 입출력에 관한 주제가 여러 차례 언급되긴 하였지만 여기서는 입출력 전반에 걸쳐 보다 완전한 설명을 제시한다

- 입출력 하드웨어의 기본적인 사항을 설명한다
  - 하드웨어 인터페이스의 특성 -> 운영체제가 제공해야 할 내부 기능이 있다
- 운영체제가 제공하는 입출력 서비스들과 응용 프로그램에 제공되는 입출력 인터페이스에 대해 살펴본다
- `운영체제`가 `하드웨어 인터페이스`와 `응용 인터페이스` 간의 `간격을 어떻게 메우는지`를 설명한다
- 응용 프로그램이 컨트롤러 코드들을 동적으로 파이프라인 화 할 수 있는 UNIX System V의 STREAMS(streams)를 기법에 대해 논의한다
- `입출력의 성능 향상`을 위한 `운영체제 설계 원리`와 입출력의 성능에 대해 살펴본다

#### 이 장의 목표

- 운영체제의 입출력 서브시스템의 구조를 살펴본다
- 입출력 하드웨어의 원리와 복잡함에 대해 논의한다
- 입출력 하드웨어와 소프트웨어의 성능 측면을 상술한다
- 폴링
- 인터럽트
- DMA

## 12.1 개관

- `컴퓨터에 연결된 장치들을 제어`하는 일은 운영체제의 주요 관심사이다
  - 마우스, 하드디스크, 등 입출력 장치들은 기능이나 속도 면에서 매우 다양하기 때문에 각각의 특성에 맞는 제어가 필요하다
  - 이와 같은 `다양한 제어 방법들`이 `커널의 입출력 서브시스템(I/O subsystem)을 형성`하며, 커널의 다른 부분이 입출력 장치를 관리하는 복잡한 일에 신경을 쓰지 않게 해준다
- 포트, 버스, 장치 컨트롤러 등과 같은 표준적인 하드웨어 요소들은 엄청나게 다양한 입출력 장치를 수용할 수 있다
  - 서로 다른 장치들의 다양성을 가려주기 위해서 운영체제 커널은 장치 드라이버 모듈(device driver module)을 사용하도록 구성되어 있다
- `장치 드라이버` : `모든 하드웨어를 일관된 인터페이스로 표현`해주며, 이러한 인터페이스를 그보다 상위층인 `커널의 입출력 서브시스템에 제공`해준다
  - 이는 시스템 콜이 응용과 운영체제 간에 표준적인 인터페이스를 제공하는 것과 유사하다

## 12.2 입출력 하드웨어 (I/O Hardware)

- 컴퓨터에서 작동되는 다양한 종류의 장치들
  - 저장장치 : 디스크, 테이프
  - 전송 장치 : 네트워크 연결, 블루투스
  - 사용자 인터페이스 장치 : 스크린, 키보드, 마우스, 오디오 입출력 등
- 이러한 다양한 입출력 장치들이 어떻게 부착되고 어떻게 제어되는지를 이해하기 위해 몇 가지 표준적인 개념들만 이해하면 된다
- 하드웨어 장치 - 케이블 or 무선 - 컴퓨터 시스템
  - 포트 : 연결점
    - e.g. 직렬 포트
  - 버스 : 연결선, 하나의 장치들이 공동으로 여러 선(wire)을 사용한다면 이러한 선을 버스라고 부른다
    - e.g. PCI 버스
    - 버스의 정의는 `회선의 집합`으로써 어떻게 해야 메시지를 주고 받을 수 있는 지를 정한 `프로토콜(protocol)까지를 포함`한다
- 입출력 예시
  - 메시지 - 전선 - 전압의 패턴에 의해 전달
  - 데이지 체인 : 장치 A -> 장치 B -> 장치 C -> 컴퓨터의 포트
    - 데이지 체인은 통상 하나의 버스처럼 동작한다

![12-1](./images/12-1_%EC%A0%84%ED%98%95%EC%A0%81%EC%9D%B8PC%EB%B2%84%EC%8A%A4%EA%B5%AC%EC%A1%B0.png)

- 그림 12.1 전형적인 PC 버스 구조

- 버스는 컴퓨터 구조에서 널리 사용되고 신호 방식, 속도, 처리량 및 연결 방식에 따라 다양한 종류가 있다
- 그림 12.1은 전형적인 PC 버스 구조를 보여준다

  - PCI 버스(일반적인 PC 시스템 버스)가 프로세서 - 메모리 `서브시스템`을
    - 고속 장치와 키보드와 직렬,
    - USB 포트 처럼 상대적으로 느린 장치들을 연결하는 확장 버스(expansion bus)에 연결하는 모습을 나타내고 있다
  - 왼쪽 하단 - 네 개의 디스크가 SAS 컨트롤러에 접속된 직렬연결SCSI(SAS) 버스에 연결되어 있는 것을 볼 수 있다

- 컨트롤러 : 포트, 버스 또는 장치를 동작할 수 있는 전자장치 집합체이다
  - 직렬 포트 컨트롤러는 가장 간단한 장치 컨트롤러이다
  - 광섬유 채널(FC) 컨트롤러 : 복잡, 데이터 센터에서 사용
    - 종종 컴퓨터의 버스에 연결되는 별도의 회로보드 또는 호스트 버스 어댑터(HBA)로 구현
    - FC 프로토콜 메시지를 처리할 수 있는 프로세서, 마이크로코드 및 일부 전용 메모리가 포함되어 있다

### 12.2.1 메모리 맵드 입출력 (Memory Mapped I/O)

- `입출력 전송`을 하기 위해 `처리기(processor)`는 어떻게 `명령어와 데이터를` `컨트롤러에 전달`하는가?
  - 모든 `컨트롤러는` (제어용 또는 데이터용) `레지스터를 가지고 있다`
  - 본체의 `프로세서는` 이들 `컨트롤러의 레지스터에` `비트 패턴을 쓰거나 읽음으로써 입출력을 수행`한다
- 이러한 통신을 수행하는 한 방법은 "특별한 입출력 명령어"를 사용하는 것이다
  - `입출력 명령어`는 `해당 장치에 맞는 버스 회선을 선택`하여 장치 레지스터로 비트들을 보내거 읽어오도록 촉발한다
- 다른 방법, 특수 입출력 명령어 대신 `장치 제어 레지스터`를 `프로세서의 주소 공간으로 매핑`한다

  - `메모리 맵드 입출력(memory-mapped I/O)` 방식
  - 주변 장치 레지스터들은 메모리 주소와 일대일 대응된다
  - CPU는 물리 메모리에 매핑된 장치-제어 레지스터를 읽고 쓸 때 표준 데이터 명령을 사용함으로써 입출력 요청을 수행하게 된다

- 과거에는 PC는 `일부 장치`를 제어하기 위해 `입출력 명령`을 사용하고, `다른 장치들`을 제어하기 위해 `메모리 맵드 입출력`을 사용했다
  - 그림 12.2는 일반적인 PC 입출력 포트 주소들을 보여준다

![12-2](./images/12-2_PC%EC%97%90%EC%84%9C-%EC%9E%A5%EC%B9%98-%EC%9E%85%EC%B6%9C%EB%A0%A5-%ED%8F%AC%ED%8A%B8%EC%9D%98-%EC%9C%84%EC%B9%98%EC%9D%BC%EB%B6%80.png)

- 그림 12.2 PC에서 장치 입출력 포트의 위치(일부)

- 메모리 영역에 데이터를 기록하면
  - 컨트롤러가 자동으로 그것을 스크린에 출력
    - 이 메모리를 기반으로 스크린 이미지를 형성
  - 단순해서 사용하기에 좋다
  - 메모리에 기록하는 것은 입출력 명령어를 사용하는 것보다 빠르다
- 시간이 지남에 따라 시스템은 메모리 맵드 I/O로 바뀌어왔다
- 오늘날 대부분의 I/O는 메모리 맵드 I/O를 사용하여 장치 컨트롤러가 수행한다

- 입출력 장치 컨트롤러는 보통 네 개의 레지스터로 구성되어 있는데
  - `상태(status), 제어(control), 입력(data-in), 출력(data-out) 레지스터`들이다
    - 입력 레지스터는 호스트가 입력을 얻기 위해 읽기를 수행한다
    - 출력 레지스터는 호스트가 데이터를 출력하기 위해 쓰기를 수행한다
    - 상태 레지스터는 호스트가 읽는 용도이며, 이 비트들은 현재의 명령이 완료되었는지, 입력 레지스터로부터 한 바이트를 읽어도 되는지, 그리고 오류가 있었는가와 같은 상태들을 보고한다
    - 제어 레지스터는 호스트가 주변 장치에 입출력 명령을 내리거나 장치의 모드를 변경하기 위해 쓰기를 수행하는 대상이다
      - 예를 들어, 직렬 포트의 제어 레지스터의 각 비트는 쌍방향 통신과 단방향 통신 중 어느 것을 선택할 것인지, 패리티 검사를 할 것이지, 7이나 8비트를 쓸 것인지 등을 지정할 수 있으며, 일부 비트들은 직렬 포트가 지원하는 속도 중 하나를 선택하는 데 사용된다
  - 입력 및 출력 레지스터 등의 데이터 레지스터들은 보통 1~4바이트이다
    - 어떤 컨트롤러들은 이러한 데이터 레지스터의 크기를 확장하기 위해 FIFO칩들을 제공 - FIFO칩은 데이터의 발생이 돌발적으로 많아지는 상황이 발생하더라도 대응할 수 있다

### 12.2.2 폴링
